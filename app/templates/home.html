<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Buscador de Cajeros ‚Äì UPEA</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- Leaflet -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.min.js"></script>
</head>
<body>

<div class="container py-4">
    

    <!-- Header logos -->
    <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap">
        <img src="{{ url_for('static', filename='upea.png') }}" alt="Logo Izquierdo" width="80" height="80">
        <img src="{{ url_for('static', filename='escudo.png') }}" alt="Logo Derecho" width="80" height="80">
    </div>
    <!-- T√≠tulo principal -->
    <h2 class="titulo-upea text-center mb-4">Buscador de Cajeros ‚Äì UPEA</h2>

    <!-- Contenedor mapa + buscador -->
<div id="map-container">
    <!-- Mapa -->
    <div id="map"></div>

        <!-- Buscador -->
    <div class="panel-derecho">

            <!-- üîµ NUEVO: Direcci√≥n exacta del usuario -->
            <div class="alert alert-info">
                <b>üìç Tu ubicaci√≥n actual:</b><br>
                <span id="mi-direccion">Detectando...</span>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Seleccionar Banco</label>
                <select id="banco" class="form-select">
                    <option value="todos">Todos</option>
                    <option value="BCP">BCP</option>
                    <option value="BNB">BNB</option>
                    <option value="Union">Banco Uni√≥n</option>
                    <option value="Econ√≥mico">Banco Econ√≥mico</option>
                    <option value="FIE">Banco FIE</option>
                </select>
            </div>
            <button class="btn btn-upea mb-3" onclick="enviar()">Buscar Cajeros Cercanos</button>
            <div id="resultado"></div>
        </div>
    </div>


    <!-- Informaci√≥n -->
    <div class="card shadow-lg p-4 borde-upea-oscuro mt-5">
        <h4 class="text-center mb-3">üéØ ¬øQu√© hace esta aplicaci√≥n?</h4>
        <ul>
            <li>Obtiene tu ubicaci√≥n mediante geolocalizaci√≥n.</li>
            <li>Identifica los cajeros m√°s cercanos de distintos bancos.</li>
            <li>Aplica c√°lculo geoespacial con la f√≥rmula Haversine.</li>
            <li>Utiliza SQLite como base de datos local.</li>
            <li>Permite visualizar las rutas en un mapa interactivo.</li>
        </ul>

        <h4 class="mt-4 mb-3 text-center">üìå ¬øC√≥mo funciona el sistema?</h4>
        <ul>
            <li><b>Captura tu posici√≥n GPS</b> mediante el navegador.</li>
            <li><b>Filtra</b> los cajeros por banco o muestra todos.</li>
            <li><b>Calcula</b> la distancia entre tu ubicaci√≥n y cada cajero registrado.</li>
            <li><b>Ordena</b> los resultados del m√°s cercano al m√°s lejano.</li>
            <li><b>Muestra</b> los cajeros con opci√≥n para verlos en un mapa interactivo.</li>
        </ul>

        <h4 class="mt-4 mb-3 text-center">üåç Relevancia en SIG</h4>
        <ul>
            <li>Geolocalizaci√≥n en aplicaciones web.</li>
            <li>An√°lisis espacial b√°sico (distancias geod√©sicas).</li>
            <li>Uso de coordenadas geogr√°ficas y proyecciones.</li>
            <li>Integraci√≥n de mapas digitales mediante Leaflet.</li>
            <li>Gesti√≥n y almacenamiento de datos espaciales en SQLite.</li>
        </ul>

        <h4 class="mt-4 mb-3 text-center">üèô Aplicaci√≥n en la gesti√≥n urbana y territorial</h4>
        <ul>
            <li>Estudios de accesibilidad a servicios financieros.</li>
            <li>Planificaci√≥n urbana en zonas con alta demanda de cajeros.</li>
            <li>Identificaci√≥n de √°reas sin cobertura bancaria.</li>
            <li>Evaluaci√≥n del comportamiento geogr√°fico de los usuarios.</li>
            <li>Optimizaci√≥n de rutas y movilidad en √°reas congestionadas.</li>
        </ul>

        <h4 class="mt-4 mb-3 text-center">üéì Objetivos Acad√©micos</h4>
        <ul>
            <li>Aplique conceptos de SIG en un sistema funcional.</li>
            <li>Comprenda el uso de datos espaciales y su an√°lisis.</li>
            <li>Dise√±e interfaces que integren geolocalizaci√≥n real.</li>
            <li>Utilice herramientas modernas como Leaflet y SQLite.</li>
            <li>Combine teor√≠a y pr√°ctica en un proyecto √∫til para la comunidad.</li>
        </ul>
    </div>
</div>

<!-- Footer -->
<footer class="footer-fijo">
    <div class="container">
        <p class="mb-0"><b>II/2025 ‚Äì SIG ‚Äì FFFG ‚Äì UPEA</b></p>
    </div>
</footer>

<!-- Scripts -->
<script>
let userLat = -16.5;
let userLon = -68.15;
let markers = [];
let rutaLayer = null;
let userMarker = null;
let listaAtms = [];

/* ================================
   MAPA ‚Äì ICONO FIJO
   ================================ */
const map = L.map('map', {
    zoomAnimation: true,
    markerZoomAnimation: false
}).setView([userLat, userLon], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/">OSM</a>',
    maxZoom: 19
}).addTo(map);

const atmIcon = L.icon({
    iconUrl: '/static/atm_icon.png',
    iconSize: [32, 37],
    iconAnchor: [16, 37],
    popupAnchor: [0, -30]
});

/* ================================
   üîµ FUNCI√ìN NEW: Obtener direcci√≥n de usuario
   ================================ */
async function obtenerDireccion(lat, lon) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;

    try {
        const resp = await fetch(url);
        const data = await resp.json();

        document.getElementById("mi-direccion").textContent =
            data.display_name ?? "No se pudo obtener direcci√≥n";
    } catch (e) {
        document.getElementById("mi-direccion").textContent =
            "Error al obtener la direcci√≥n";
    }
}

/* ================================
   ACTUALIZAR UBICACI√ìN + DIRECCI√ìN
   ================================ */
function actualizarUbicacion(pos) {
    userLat = pos.coords.latitude;
    userLon = pos.coords.longitude;

    if(!userMarker) {
        userMarker = L.circleMarker([userLat, userLon], {
            radius: 8,
            color:'#000000ff',
            fillColor:'#000000ff',
            fillOpacity:1
        }).bindPopup("Tu ubicaci√≥n").addTo(map);
    } else {
        userMarker.setLatLng([userLat, userLon]);
    }

    // MOVEMOS MAPA
    map.setView([userLat, userLon], 15);

    // üîµ NUEVO: Obtener direcci√≥n real
    obtenerDireccion(userLat, userLon);

    if(listaAtms.length > 0) {
        recalcularDistancias();
    }
}

/* ================================
   RECALCULAR DISTANCIAS
   ================================ */
function recalcularDistancias() {
    listaAtms.forEach(atm => {
        atm.distancia = distancia(userLat, userLon, atm.lat, atm.lon);
    });

    listaAtms.sort((a,b) => a.distancia - b.distancia);

    let html = `<h5 class="mt-3">Resultados:</h5>`;
    listaAtms.slice(0,10).forEach(a => {
        html += `
        <div class="alert alert-secondary shadow-sm">
            <b>${a.banco}</b><br>
            Distancia: ${a.distancia.toFixed(2)} km<br>
            <button class="btn btn-sm btn-upea mt-2" onclick="mostrarRuta(${a.lat}, ${a.lon})">C√≥mo llegar</button>
        </div>`;
    });
    document.getElementById("resultado").innerHTML = html;

    markers.forEach(m => map.removeLayer(m));
    markers = [];

    listaAtms.forEach(atm => {
        const marker = L.marker([atm.lat, atm.lon], {icon: atmIcon}).addTo(map);
        marker.bindPopup(`<b>${atm.banco}</b><br>Direcci√≥n: ${atm.direccion}<br>Distancia: ${atm.distancia.toFixed(2)} km`);
        markers.push(marker);
    });
}

/* ================================
   ENVIAR PETICI√ìN
   ================================ */
function enviar() {
    const banco = document.getElementById("banco").value;

    fetch("/buscar", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({lat: userLat, lon: userLon, banco})
    })
    .then(res => res.json())
    .then(lista => {
        listaAtms = lista;
        recalcularDistancias();
    });
}

/* ================================
   MOSTRAR RUTA EN MAPA
   ================================ */
function mostrarRuta(latDest, lonDest) {
    if(rutaLayer) map.removeControl(rutaLayer);

    rutaLayer = L.Routing.control({
        waypoints: [
            L.latLng(userLat, userLon),
            L.latLng(latDest, lonDest)
        ],
        routeWhileDragging: false,
        showAlternatives: true,
        lineOptions: { styles: [{ color: '#000', weight: 5 }] },
        createMarker: () => null
    }).addTo(map);

    const bounds = L.latLngBounds([[userLat, userLon],[latDest, lonDest]]);
    map.fitBounds(bounds, {padding: [50,50]});
}

/* ================================
   DISTANCIA HAVERSINE
   ================================ */
function distancia(lat1, lon1, lat2, lon2) {
    const R = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLon = (lon2 - lon1) * Math.PI / 180;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
    return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

/* ================================
   GEOLOCALIZACI√ìN
   ================================ */
if(navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
        actualizarUbicacion,
        err => {
            document.getElementById("mi-direccion").textContent =
                "No se pudo obtener la ubicaci√≥n.";
            alert("Habilita el GPS o la geolocalizaci√≥n del navegador.");
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
} else {
    alert("Tu navegador no soporta geolocalizaci√≥n.");
}
</script>
